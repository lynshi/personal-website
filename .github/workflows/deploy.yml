name: Deploy to Azure

on: [push]

jobs:
  build:

    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [12.x]

    steps:
    - uses: actions/checkout@v1
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v1
      with:
        node-version: ${{ matrix.node-version }}

    - name: Azure service principal login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
  
    - name: Install dependencies
      run: |
        npm install
        npm install -g gatsby-cli

    - name: Build with Gatsby
      run: gatsby build
    
    - name: Azure upload
      uses: azure/CLI@v1
      with:
        azcliversion: 2.0.72
        inlineScript: |
          az storage blob delete-batch -s "\$web" --connection-string "${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}"
          az storage blob upload-batch -d "\$web" -s public --connection-string "${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}

    - name: Purge CDN
      run:
        az cdn endpoint list --profile-name ${{ secrets.AZURE_CDN_PROFILE_NAME }} --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }}
        az cdn endpoint purge -n ${{ secrets.AZURE_CDN_ENDPOINT }} --profile-name ${{ secrets.AZURE_CDN_PROFILE_NAME }} --content-paths /* --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} --no-wait

    - name: Azure logout
      run: |
        az logout
